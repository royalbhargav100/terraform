parameters:
  - name: environment
    type: string
  - name: backendServiceArm
    type: string
  - name: backendResourceGroupName
    type: string
  - name: backendStorageAccountName
    type: string
  - name: backendContainerName
    type: string

steps:
  - checkout: self
    fetchDepth: 0
  
  - task: TerraformInstaller@0
    displayName: 'Install Terraform $(terraformVersion)'
    inputs:
      terraformVersion: '$(terraformVersion)'
  
  - task: AzureCLI@2
    displayName: 'Initialize Backend for ${{ parameters.environment }}'
    inputs:
      azureSubscription: '${{ parameters.backendServiceArm }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Initializing Terraform backend for ${{ parameters.environment }}..."
        
        # Get storage account key
        ACCOUNT_KEY=$(az storage account keys list \
          --resource-group ${{ parameters.backendResourceGroupName }} \
          --account-name ${{ parameters.backendStorageAccountName }} \
          --query '[0].value' -o tsv)
        
        export ARM_ACCESS_KEY=$ACCOUNT_KEY
  
  - script: |
      echo "Planning Terraform for ${{ parameters.environment }} environment..."
      cd environments/${{ parameters.environment }}
      
      components=(resource-group networking compute database storage security webapp)
      plan_count=0
      
      for component in "${components[@]}"; do
        if [ -d "$component" ]; then
          echo ""
          echo "##[section] Planning component: $component"
          cd "$component"
          
          # Initialize with backend
          terraform init \
            -backend=true \
            -backend-config="resource_group_name=${{ parameters.backendResourceGroupName }}" \
            -backend-config="storage_account_name=${{ parameters.backendStorageAccountName }}" \
            -backend-config="container_name=${{ parameters.backendContainerName }}" \
            -backend-config="key=${{ parameters.environment }}/$component/terraform.tfstate"
          
          # Generate plan
          terraform plan \
            -var-file=terraform.tfvars \
            -out=tfplan_$component
          
          if [ $? -eq 0 ]; then
            echo "Plan generated successfully for $component"
            ((plan_count++))
          else
            echo "##[error] Plan failed for component: $component"
            exit 1
          fi
          
          cd ..
        fi
      done
      
      echo ""
      echo "##[section] Planning completed for ${{ parameters.environment }} environment ($plan_count components planned)"
    displayName: 'Terraform Plan ${{ parameters.environment }}'
    env:
      ARM_SUBSCRIPTION_ID: '$(arm_subscription_id)'\n      ARM_CLIENT_ID: '$(arm_client_id)'\n      ARM_CLIENT_SECRET: '$(arm_client_secret)'\n      ARM_TENANT_ID: '$(arm_tenant_id)'\n      TF_IN_AUTOMATION: 'true'
    continueOnError: false
  
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Plan Artifacts for ${{ parameters.environment }}'
    inputs:
      pathToPublish: '$(System.DefaultWorkingDirectory)/environments/${{ parameters.environment }}'
      artifactName: 'tfplan-${{ parameters.environment }}'
      publishLocation: 'Container'
    continueOnError: true
